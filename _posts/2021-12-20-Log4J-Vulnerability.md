---
layout: post
title: Log4j Vulnerability
---

Log4J version 2.16 is vulnerable to DoS. Allow hackers to control java-based web servers and launch what are called ‘remote code execution’ (RCE) attacks. In simple words, the vulnerability could allow a hacker to take control of a system.

## Problem Statement

- Log4J version 2.16 is vulnerable to DoS via "${${::-${::-$${::-j}}}}"
- Allow hackers to control java-based web servers and launch what are called ‘remote code execution’ (RCE) attacks. In simple words, the vulnerability could allow a hacker to take control of a system.
- Lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS)
- Apache Log4j2 versions 2.0-alpha1 through 2.16.0 did not protect from uncontrolled recursion from self-referential lookups. When the logging configuration uses a non-default Pattern Layout with a Context Lookup (for example, $${ctx:loginId}), attackers with control over Thread Context Map (MDC) input data can craft malicious input data that contains a recursive lookup, resulting in a StackOverflowError that will terminate the process. This is also known as a DOS (Denial of Service) attack.
- If a string substitution is attempted for any reason on the following string, it will trigger an infinite recursion, and the application will crash: ${${::-${::-$${::-j}}}}
- With high number of user controlled and logged exceptions, stack rewinds, cpu peaks, latency and produced garbage and safepoints

## Analysis in Apache Log4J
- Log4j string substitutor class but in the Apache Commons Text component. It would be interesting to know if this string is a problem there as well.
- There is an `enableSubstitutionInVariables` in the StrSubstitutor that should be become disabled by default and configurable globally via env variable/property similar to LOG4J_FORMAT_MSG_NO_LOOKUPS.
- UPD: it does not prevent `checkCyclicSubstitution` from throwing but maybe it should.
- If the suspect string is put in the PatternLayout, then that specific patternLayout will crash when loaded and replace itself with a PatternLayout that just logs what is handed to it with no formatting.
- Cyclic substitution check was an edge case that wasn't validated properly.

## Solution
- Upgrade Log4J with latest version 2.17.0.

## AWS details (High Level)
- https://aws.amazon.com/blogs/containers/advice-on-mitigating-the-apache-log4j-security-issue-for-eks-ecs-and-fargate-customers/
https://aws.amazon.com/security/security-bulletins/AWS-2021-006/
- Amazon RDS: Amazon RDS and Amazon Aurora have been updated to mitigate the issues identified in CVE-2021-44228.
- Amazon VPC: Amazon VPC, including Internet Gateway and Virtual Gateway services, have been updated to mitigate the Log4j issue referenced in CVE-2021-44228.
- AWS AppSync: AWS AppSync has been updated to mitigate the issues identified in CVE-2021-44228 and CVE-2021-45046.
- AWS Certificate Manager: AWS Certificate Manager services have been updated to mitigate the issues identified in CVE-2021-44228.
- ACM Private CA services have been updated to mitigate the issues identified in CVE-2021-44228.
- AWS Service Catalog: AWS Service Catalog has been updated to mitigate the issues identified in CVE-2021-44228.
- AWS Systems Manager: AWS Systems Manager service has been updated to mitigate the issues identified in CVE-2021-44228. The Systems Manager agent itself is not affected by this issue.

## Additional Information
- CVE-2021-44228 (CVE number is the unique number given to each vulnerability discovered across the world)